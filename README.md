Работает на основе проекта Vapor. Для начала работы необходимо установить: https://docs.vapor.codes/install/macos

Используется кастомный шаблон Vapor-проекта: https://github.com/dmoroz0v/ChatBotSDKVaporTemplate - детальнее что предоставляет шаблон читайте в его README.md

# Старт

### Создание проекта

`vapor new PROJECT_NAME --template https://github.com/dmoroz0v/ChatBotSDKVaporTemplate --branch main`

В результате в текущей директории будет создана папка с именем проекта и содержимым бота

### Параметры окружения

Используется файл `.env` в корне проекта. Файл автометически загружается в переменные окружения и игнорируется git-ом. В процессе разработки в нём будут находиться личные dev конфигурационные данные. При разворачивании бота для пользователей в `.env` нужно прописать prod конфигурационные данные

Создать файл выполнив в папке проекта `touch .env` - будет создан пустой файл

### Рабочая директория

При запуске через терминал рабочей директорией является директория проекта. Для запуска через Xcode необходимо провести дополнительную настройку рабочей директории и явно указать директорию проекта - об этом далее в инструкции

Рабочая диреткория используется для:
- вычитывания файла `.env`
- создания файла базы данных SQLite (если выбрать использование SQLite в качестве Fluent(ORM) на этапе создания проекта)
- вычитывания сертификатов в случае работы бота через Webhook

### Указать token бота

1. Создать бота через https://t.me/botfather
2. Получить у него токен
3. В файл `.env` прописать `BOT_TOKEN=...`

### Локальный запуск бота

Бот поумолчанию запускается через Long Polling. Для включения работы через Webhook смотрите инструкции ниже

Использовать один из двух вариантов запуска:

- Запуск через терминал: в папке проекта выполнить `swift run`
- Запуск через Xcode
    
    1. Открыть проект в Xcode: в папке проекта выполнить `open Package.swift`
    2. Настроить рабочую директорию согласно документации https://docs.vapor.codes/getting-started/xcode/#custom-working-directory
    3. Запустить нажатием `Run`

# Webhook

### Настройка переменных окружения

В файл `.env` добавить дополнительно параметры:
````
BOT_TOKEN=...

#Домен на который настроен Webhook
BOT_DOMAIN=...

#[опционально] ip-адрес на который настроен домен
#BOT_IP_ADDRESS=...

#Включить работу через Webhook. Удалить чтобы переключить бота на Long Polling
BOT_MODE=WEBHOOK

#Данные для ssl-серификата
CERT_COUNTRY=RU
CERT_CITY=Moscow
CERT_COMPANY="My Company"
CERT_DEPARTMENT="My Department"
````

Бот сам при запуске сделает вызов методов апи для установки/удаления Webhook

### Настройка для локального запуска
1. Понадобится белый `ip` адрес
2. Домен на который будет настроен Webhook привязать к белому `ip`
3. Прописать локальный `ip` адрес компьютера и домен в `etc/hosts` как-то так:

    `192.168.0.XXX   BOT_DOMAIN` (`BOT_DOMAIN` заменить на домен)
4. В роутере закрепить текущий локальный `ip` адрес компьютера за текущим привязаным MAC-адресом
5. В роутере прокинуть трафик по `8443` порту на текущий локальный `ip` адрес компьютера
6. В папке проекта выполнить скрипт `./make_cert.sh`

    Скрипт удаляет старые и создает новые `cert.pem` и `key.pem` в папке `Cert` директории проекта. `*.pem` файлы игнорируются git-ом
7. Запустить бота

# Deploy используя Docker в Яндекс Облаке
TBD