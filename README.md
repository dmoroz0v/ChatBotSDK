# CharBotSDK

## Создание нового проекта

1. Установить Vapor

https://docs.vapor.codes/4.0/install/macos/

2. Cоздать новый проект. Например будем использовать имя `HelloBot`

`vapor new HelloBot --template https://github.com/dmoroz0v/ChatBotSDKVaporTemplate --branch main`

Обратите внимание: если на вопросы нужен ли Fluent ответить положительно, то будет добавлена работа с БД и команды `insert` и `select`

3. Перейти в директорию проекта

`cd HelloBot`

4. Открыть проект в Xcode

Оставаясь в директории с проектом выполнить `open Package.swift`

## [Опционально, если ответили что нужен Fluent] Прописать Custom Working Directory

При запуске через terminal база данных создается в директории исходного кода, поэтому для запуска через xcode желательно указать такой же путь - на случай если будете запускать то в терминале, то в xcode - чтобы использовалась одна и та же база данных

Согласно документации https://docs.vapor.codes/getting-started/xcode/#custom-working-directory указать в схеме

## Настройка телеграм бота

1. Создать бота через https://t.me/botfather

2. Получить у него токен

3. В директорию с проектом добавить файл `.env` и прописать в него `BOT_TOKEN=...` - вместо `...` указать токен

## Запуск через long polling локально

1. В директории с проектом в файл `.env` добавить `LONG_POLLING=1` новой строчкой

2. Запустить бота через схему `HelloBot` нажав на `Run` в Xcode либо `swift run` в директории проекта

## Что бот умеет из коробки

В новом проекте сразу согласно шаблону реализованы несколько команд для примера. Всего реализовано 6 команд:

`/revert` - команда попросит ввести строку и развернёт её

`/pick` - команда предложит выбрать 1 из 8 элементов

`/insert` - команда предложит ввести текст, который необходимо записать в базу данных

`/select` - команда выведет записи из базы данных, которые были добавлены командой /insert

`/cancel` - команда для отмены текущей выполняемой команды

`/help` - команда для получения справки

## Запуск через webhook локально

1. В файле `.env` не должно быть `LONG_POLLING=1`

2. Настройка домена и порта

2.1. Вам понадобится белый `ip` адрес)

2.2. Зарегистрировать домен и привязать его у своему белому `ip`. Предположим у нас такой домен `mybot.mydomain.ru` (далее домен везде заменять на свой настоящий)

2.3. Прописать свой локальный `ip` адрес и домен в `etc/hosts`. Как-то так:

`192.168.0.XXX   mybot.mydomain.ru` (не забываем заменить `ip` и `mybot.mydomain.ru` на ваши настоящие)

2.4. Прокинуть порт в своем роутере, рекомендую `8443` так как в `docker-compose` он указан (хотя локально это не влияет, но чтобы не запутатся пусть будут лучше одинаковые). Необходимо чтобы роутер редиректил входящий трафик по данному порту на ваш локальный `ip` адрес.

2.5. В файл `.env` добавить `BOT_DOMAIN=mybot.mydomain.ru` (не забываем заменить `mybot.mydomain.ru` на ваш настоящий домен)

3. Генерация сертификата и регистрация `webhook`

TBD

4. Прописать Custom Working Directory

TBD

5. Запустить бота через схему `HelloBot` нажав на `Run` в Xcode либо `swift run` в директории проекта

## Deploy используя Docker

TBD