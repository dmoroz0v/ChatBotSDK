Работает на основе проекта Vapor. Для начала работы необходимо установить: https://docs.vapor.codes/install/macos

Используется кастомный шаблон Vapor-проекта: https://github.com/dmoroz0v/ChatBotSDKVaporTemplate - детальнее что предоставляет шаблон читайте в его README.md

# Старт

## Создание проекта

`vapor new PROJECT_NAME --template https://github.com/dmoroz0v/ChatBotSDKVaporTemplate --branch main`

В результате в текущей директории будет создана папка с именем проекта и содержимым бота

## Параметры окружения

Используется файл `.env` в корне проекта. Файл автометически загружается в переменные окружения и игнорируется git-ом. В процессе разработки в нём будут находиться личные dev конфигурационные данные. При разворачивании бота для пользователей в `.env` нужно прописать prod конфигурационные данные

Создать файл выполнив в папке проекта `touch .env` - будет создан пустой файл

## Рабочая директория

При запуске через терминал рабочей директорией является директория проекта. Для запуска через Xcode необходимо провести дополнительную настройку рабочей директории и явно указать директорию проекта - об этом далее в инструкции

Рабочая диреткория используется для:
- вычитывания файла `.env`
- создания файла базы данных SQLite (если выбрать использование SQLite в качестве Fluent(ORM) на этапе создания проекта)
- вычитывания сертификатоа в случае работы бота через Webhook

## Указать token бота

1. Создать бота через https://t.me/botfather
2. Получить у него токен
3. В файл `.env` прописать `BOT_TOKEN=...`

## Локальный запуск бота

Бот поумолчанию запускается через Long Polling. Для включения работы через Webhook смотрите инструкции ниже

- Запуск через терминал: в папке проекта выполнить `swift run`
- Запуск через Xcode
    
    1. Открыть проект в Xcode: в папке проекта выполнить `open Package.swift`
    2. Настроить рабочую директорию согласно документации https://docs.vapor.codes/getting-started/xcode/#custom-working-directory
    3. Запустить нажатием `Run`

# Webhook

### Настройка домена и сертификата
1. В файл `.env` добавить `BOT_DOMAIN=...` со значением домена на который будет настроен Webhook, а так же добавить `CERT_COUNTRY`, `CERT_CITY`, `CERT_COMPANY` и `CERT_DEPARTMENT`. Параметры будут использоваться для создания ssl-сертификата

    Примерно так должен выглядить файл `.env`:

    ````
    ...
    BOT_TOKEN=...
    BOT_DOMAIN=...
    CERT_COUNTRY=RU
    CERT_CITY=Moscow
    CERT_COMPANY="My Company"
	CERT_DEPARTMENT="My Department"
    ...
    ````
2. [Опционально] В файл `.env` добавить `BOT_IP_ADDRESS=...` со значением ip адреса на который будет настроен домен
3. В папке проекта выполнить скрипт `./make_cert.sh`

    Скрипт удаляет старые и создает новые `cert.pem` и `key.pem` в папке `Cert` директории проекта. `*.pem` файлы игнорируются git-ом

### Настройка для локального запуска
1. Понадобится белый `ip` адрес
2. Домен на который будет настроен Webhook привязать к белому `ip`
3. Прописать локальный `ip` адрес компьютера и домен в `etc/hosts` как-то так:

    `192.168.0.XXX   BOT_DOMAIN` (`BOT_DOMAIN` заменить на домен)
4. В роутере закрепить текущий локальный `ip` адрес компьютера за текущим привязаным MAC-адресом
5. В роутере прокинуть трафик по `8443` порту на текущий локальный `ip` адрес компьютера

### Переключение режима бота
В файл `.env` прописать `BOT_MODE=WEBHOOK` для работы через Webhook и удалить если хочется переключиться обратно на Long Polling

Бот сам при запуске произведёт установку/удаление Webhook

# Deploy используя Docker в Яндекс Облаке
TBD