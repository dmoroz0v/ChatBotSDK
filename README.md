# CharBotSDK

Работает на основе проекта Vapor. Для начала работы необходимо установить: https://docs.vapor.codes/install/macos

Используется кастомный шаблон Vapor-проекта: https://github.com/dmoroz0v/ChatBotSDKVaporTemplate. Шаблон содержит ряд команд для демонстрации возможностей SDK. При создании проекта есть возможность выбрать использование Fluent(ORM) для работы с БД - в таком случае согласно шаблону добавляются дополнительные команды для демонстрации взаимодействия с БД

# Создание и настройка нового проекта

1. Создание нового проекта

    `vapor new PROJECT_NAME --template https://github.com/dmoroz0v/ChatBotSDKVaporTemplate --branch main`

    В результате в текущей директории будет создана папка с именем проекта и с содержимым бота

2. Конфигурационные данные для работы бота

   Используется файл `.env` в корне проекта. Файл игнорируется git-ом. В процессе разработки в нём будут находиться личные dev конфигурационные данные. При разворачивании бота в `.env` нужно прописать prod конфигурационные данные

    Создать файл выполнив в папке проекта `touch .env` - будет создан пустой файл

3. Настройка телеграм бота
    1. Создать бота через https://t.me/botfather
    2. Получить у него токен
    3. В файл `.env` прописать `BOT_TOKEN=...`

4. Что бот умеет из коробки

    В новом проекте сразу согласно шаблону реализованы несколько команд для примера:
    - `/revert` - команда попросит ввести строку, развернёт её и результат отправит ответным сообщением
    - `/pick` - команда покажет клавиатуру для выбора элемента из ограниченого набора и ответным сообщением вернёт информацию о выбраном элементе
    - `/cancel` - команда для отмены текущей выполняемой команды
    - `/help` - команда отправит справку ответным сообщением

    Если выбрать использование Fluent(ORM) на этапе создания проекта, то будут дополнительно реализованы команды:
    - `/insert` - команда попросит ввести текст, который сохранится в БД
    - `/select` - команда возьмёт все записи из БД, которые были добавлены командой `/insert` и ответным сообщением вернёт их списокм

# Локальный запуск бота

1. Открыть проект в Xcode

    В папке с проектом вызвать `open Package.swift`

2. Настроить Custom Working Directory

    Полезная информация о Custom Working Directory из документации Vapor
    > - Из неё читается файл `.env`
    > - В ней создаётся файл базы данных SQLite (если выбрать использование SQLite в качестве Fluent(ORM) на этапе создания проекта)
    > - Из неё читаются сертификаты в случае работы бота через Webhook
    > - При запуске через терминал - она по умолчанию является директорией проекта т.е. для запуска из терминала дополнительных настроек не требуется

    Сделать согласно документации https://docs.vapor.codes/getting-started/xcode/#custom-working-directory

3. Запустить одним из способов
    - В Xcode выбрать схему с именем проекта и нажать `Run`
    - В терминале в папке проекта выполнить `swift run`
  
   Бот поумолчанию запускается через Long Polling. Для включения работы через Webhook смотрите инструкции ниже

# Webhook

### Настройка домена и сертификата
1. В файл `.env` добавить `BOT_DOMAIN=...` со значением домена на который будет настроен Webhook, а так же добавить `CERT_COUNTRY`, `CERT_CITY`, `CERT_COMPANY` и `CERT_DEPARTMENT`. Параметры будут использоваться для создания ssl-сертификата

    Примерно так должен выглядить файл `.env`:

    ````
    ...
    BOT_TOKEN=...
    BOT_DOMAIN=...
    CERT_COUNTRY=RU
    CERT_CITY=Moscow
    CERT_COMPANY="My Company"
	CERT_DEPARTMENT="My Department"
    ...
    ````
2. [Опционально] В файл `.env` добавить `BOT_IP_ADDRESS=...` со значением ip адреса на который будет настроен домен
3. В папке проекта выполнить скрипт `./make_cert.sh`

    Скрипт удаляет старые и создает новые `cert.pem` и `key.pem` в папке `Cert` директории проекта. `*.pem` файлы игнорируются git-ом

### Настройка для локального запуска
1. Понадобится белый `ip` адрес
2. Домен на который будет настроен Webhook привязать к белому `ip`
3. Прописать локальный `ip` адрес компьютера и домен в `etc/hosts` как-то так:

    `192.168.0.XXX   BOT_DOMAIN` (`BOT_DOMAIN` заменить на домен)
4. В роутере закрепить текущий локальный `ip` адрес компьютера за текущим привязаным MAC-адресом
5. В роутере прокинуть трафик по `8443` порту на текущий локальный `ip` адрес компьютера

### Переключение режима бота
В файл `.env` прописать `BOT_MODE=WEBHOOK` для работы через Webhook и удалить если хочется переключиться обратно на Long Polling

Бот сам при запуске произведёт установку/удаление Webhook

# Deploy используя Docker в Яндекс Облаке
TBD